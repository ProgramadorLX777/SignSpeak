import cv2
import mediapipe as mp
import numpy as np
import os
import time
import tkinter as tk
from tkinter import simpledialog, messagebox

# ------------------ TKINTER CONFIG ------------------
root = tk.Tk()
root.withdraw()  # Ocultar ventana principal

# Pedir nombre de la se√±a a grabar
sign_name = simpledialog.askstring("Se√±a din√°mica", "Ingrese el nombre de la se√±a a grabar:")

if not sign_name:
    messagebox.showerror("Error", "Debe ingresar un nombre para la se√±a.")
    raise SystemExit

# -----------------------------------------------------

mp_hands = mp.solutions.hands


def record_dynamic_sign(sign_name, output_dir="data_dynamic", record_seconds=5):
    """
    Graba una se√±a din√°mica (con movimiento) durante 5 segundos una vez que haya una mano presente.
    Guarda un archivo .npy por cada frame grabado, como secuencia temporal.
    """

    # Crear carpeta principal
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    # Crear carpeta espec√≠fica para la se√±a
    sign_path = os.path.join(output_dir, sign_name)
    if not os.path.exists(sign_path):
        os.makedirs(sign_path)

    cap = cv2.VideoCapture(0)

    print(f"\n‚ñ∂ Aproxime su mano para comenzar a grabar la se√±a din√°mica: '{sign_name}'")
    print("La grabaci√≥n NO comenzar√° hasta detectar una mano...")

    with mp_hands.Hands(
        static_image_mode=False,
        max_num_hands=1,
        min_detection_confidence=0.6,
        min_tracking_confidence=0.6
    ) as hands:

        # --- 1) ESPERAR A DETECTAR MANO ---
        while True:
            ret, frame = cap.read()
            if not ret:
                continue

            frame = cv2.flip(frame, 1)
            rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
            results = hands.process(rgb)

            if results.multi_hand_landmarks:

                # ----------------- 5 SEGUNDOS DE CUENTA REGRESIVA -----------------
                for i in range(5, 0, -1):
                    ret2, frame2 = cap.read()
                    frame2 = cv2.flip(frame2, 1)

                    cv2.putText(frame2, f"Grabando en: {i}s",
                                (50, 80), cv2.FONT_HERSHEY_SIMPLEX,
                                1.5, (0, 255, 0), 3)

                    cv2.imshow("Grabaci√≥n de Se√±a Din√°mica", frame2)
                    cv2.waitKey(1000)

                break

            # Mostrar mensaje mientras no hay mano
            cv2.putText(frame, "Acerque su mano para comenzar...",
                        (20, 60), cv2.FONT_HERSHEY_SIMPLEX,
                        1.2, (0, 0, 255), 3)

            cv2.imshow("Grabaci√≥n de Se√±a Din√°mica", frame)

            if cv2.waitKey(1) & 0xFF == 27:  # ESC para salir
                cap.release()
                cv2.destroyAllWindows()
                return

        # --- 2) COMENZAR GRABACI√ìN ---
        print("\nüé• Grabando movimiento durante 5 segundos...\n")
        start_time = time.time()
        frame_id = 0

        while True:
            ret, frame = cap.read()
            if not ret:
                break

            frame = cv2.flip(frame, 1)
            rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
            results = hands.process(rgb)

            if results.multi_hand_landmarks:
                hand = results.multi_hand_landmarks[0]

                # Extraer 63 valores x,y,z (21 landmarks * 3 coords)
                landmarks = []
                for lm in hand.landmark:
                    landmarks.extend([lm.x, lm.y, lm.z])

                # Guardar frame como .npy (SECUENCIA)
                np.save(os.path.join(sign_path, f"{frame_id}.npy"),
                        np.array(landmarks))

                frame_id += 1

                # Dibujar mano
                mp.solutions.drawing_utils.draw_landmarks(
                    frame, hand, mp_hands.HAND_CONNECTIONS
                )

            # Dibujar texto
            cv2.putText(frame, "Grabando movimiento...",
                        (20, 40), cv2.FONT_HERSHEY_SIMPLEX,
                        1.2, (0, 255, 255), 3)

            cv2.imshow("Grabaci√≥n de Se√±a Din√°mica", frame)

            if time.time() - start_time >= record_seconds:
                break

            if cv2.waitKey(1) & 0xFF == 27:  # ESC para salir antes
                break

        cap.release()
        cv2.destroyAllWindows()

        print(f"‚úî Se√±a din√°mica '{sign_name}' grabada exitosamente.")
        print(f"‚úî Total de cuadros guardados: {frame_id}")

        messagebox.showinfo("Grabaci√≥n completa",
                            f"Se√±a din√°mica '{sign_name}' grabada con √©xito.\n"
                            f"Frames guardados: {frame_id}")


# Ejecutar con nombre dado por Tkinter
record_dynamic_sign(sign_name)
